# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ VPN-–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. [–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞](#–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ-–¥–æ–∫—É–º–µ–Ω—Ç–∞)
2. [–û–±–ª–∞—Å—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è](#–æ–±–ª–∞—Å—Ç—å-–ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è)
3. [–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤](#–≥–µ–Ω–µ—Ä–∞—Ü–∏—è-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤)
4. [–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏](#—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏)
5. [–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥](#–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)
6. [–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ](#—Ä–µ–∑–µ—Ä–≤–Ω–æ–µ-–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ)
7. [–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è](#–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ-—É–ª—É—á—à–µ–Ω–∏—è)

## üõ°Ô∏è –í–≤–µ–¥–µ–Ω–∏–µ

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
–î–∞–Ω–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–æ –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤, –æ—Ç–≤–µ—á–∞—é—â–∏—Ö –∑–∞:
- –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ VPN-—Å–µ—Ä–≤–µ—Ä–∞
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —á–µ—Ä–µ–∑ PKI-–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É
- –û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å–µ—Ç–µ–≤—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π

### –û–±–ª–∞—Å—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:
1. –ó–∞—â–∏—â–µ–Ω–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º —Ä–µ—Å—É—Ä—Å–∞–º –∫–æ–º–ø–∞–Ω–∏–∏
2. –†–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –º–µ–∂–¥—É –æ—Ç–¥–µ–ª–∞–º–∏
3. –ê—É–¥–∏—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π —á–µ—Ä–µ–∑ –º–µ—Ö–∞–Ω–∏–∑–º –æ—Ç–∑—ã–≤–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

---

## –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

### –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
–ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è VPN –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ [—ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç](https://github.com/Zarinec/devops-vpn-project/blob/main/scripts/gen-client-cert.sh "gen-client-cert.sh")
  > –°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–µ—Ç —Å—Ä–∞–∑—É —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ñ–∞–π–ª .ovpn, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ—Ä–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ–¥–∞—Ç—å –Ω–æ–≤–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é VPN!
<u>–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:</u>
–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –≤ /scripts/gen-client-cert.sh
–î–∞–π—Ç–µ –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ:
```bash
sudo ./scripts/gen-client-cert.sh <–∏–º—è_–∫–ª–∏–µ–Ω—Ç–∞>
```
–ü—Ä–∏–º–µ—Ä:
```bash
sudo ./scripts/gen-client-cert.sh ivanov
```
–†–µ–∑—É–ª—å—Ç–∞—Ç:
- –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: /etc/openvpn/client-configs/ivanov.ovpn
- –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏ –∫–ª—é—á –≤ PKI: /etc/easy-rsa/pki/issued/ivanov.crt, /etc/easy-rsa/pki/private/ivanov.key

## –û—Ç–∑—ã–≤ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
–î–ª—è –∑–∞–ø—É—Å–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ [—ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç](https://github.com/Zarinec/devops-vpn-project/blob/main/scripts/revoke-client-cert.sh "revoke-client-cert.sh")
```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—ã–¥–∞–Ω–Ω—ã—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
ls /etc/easy-rsa/pki/issued/
```
### 1. –û—Ç–∑—ã–≤ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
```bash
sudo ./scripts/revoke-client-cert.sh <–∏–º—è_–∫–ª–∏–µ–Ω—Ç–∞>
```
### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ CRL
```bash
openssl crl -in /etc/easy-rsa/pki/crl.pem -text -noout
```
–î–ª—è **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** CRL –¥–æ–±–∞–≤—å—Ç–µ –≤ cron:
   ```bash
   # –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ CRL
   0 3 * * 1 /etc/easy-rsa/easyrsa gen-crl
   ```
---

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏
- –í—Å–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ ```bash /etc/easy-rsa/pki/```
- –°–ø–∏—Å–æ–∫ –≤—ã–¥–∞–Ω–Ω—ã—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤:
  ```bash
  ls /etc/easy-rsa/pki/issued/
  ```
- –°–ø–∏—Å–æ–∫ –æ—Ç–æ–∑–≤–∞–Ω–Ω—ã—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤:
  ```bash 
  cat /etc/easy-rsa/pki/crl.pem | openssl crl -text -noout
  ```  
---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- –õ–æ–≥–∏ OpenVPN: /var/log/openvpn.log
- –õ–æ–≥–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤: /var/log/vpn-install.log
- –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π:
  ```bash
  sudo cat /var/log/openvpn-status.log
  ```
---

## –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è:
/etc/easy-rsa/pki/
/etc/openvpn/
/var/log/vpn-install.log
–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏:
```bash
tar -czvf /backup/vpn-backup-$(date +%F).tar.gz \
  /etc/easy-rsa/pki \
  /etc/openvpn \
  /var/log/vpn-install.log
```
---

> –í–∞–∂–Ω–æ!!!  
> –ù–µ —Ö—Ä–∞–Ω–∏—Ç–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –∫–ª—é—á–∏ (`*.key`) –≤ Git! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ .gitignore.

---

### **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è**

1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤**  
   –î–æ–±–∞–≤—å—Ç–µ –≤ `crontab`:
   ```bash
   0 3 * * * /usr/bin/find /etc/easy-rsa/pki/issued/ -name "*.crt" -exec openssl x509 -checkend 86400 -noout -in {} \; -print | mail -s "Expiring VPN Certs" admin@testcompany.com
   ```
2. –®–∞–±–ª–æ–Ω `.gitignore`  
   –î–æ–±–∞–≤—å—Ç–µ –≤ –∫–æ—Ä–µ–Ω—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è:
  ```
   *.key \
   *.ovpn \
   *.log \
   pki/
   ```
### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
1. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç:
```bash  
   sudo ./scripts/gen-client-cert.sh testuser
```   
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ .ovpn —Ñ–∞–π–ª–∞:
```bash  
   cat /etc/openvpn/client-configs/testuser.ovpn
```   
3.–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ OpenVPN-–∫–ª–∏–µ–Ω—Ç.

---

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ç–µ–≤–æ–π –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –∏ firewall

### –¢–µ–∫—É—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞ iptables
–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–µ–∫—É—â–∏—Ö –ø—Ä–∞–≤–∏–ª:
```bash
iptables -L -n -v
iptables -t nat -L -n -v
```
### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞–º–∏
1. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ:
```bash
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables-save > /etc/iptables/rules.v4
```
2. –£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ:
```bash
iptables -D INPUT <–Ω–æ–º–µ—Ä_–ø—Ä–∞–≤–∏–ª–∞>
iptables-save > /etc/iptables/rules.v4
```
## –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
### 1.–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å NAT-–ø—Ä–∞–≤–∏–ª–∞:
–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–µ–∫—É—â–∏—Ö –ø—Ä–∞–≤–∏–ª:
```bash
sudo iptables -t nat -L -n -v --line-numbers
```
**–ß—Ç–æ —Å–º–æ—Ç—Ä–∏–º:**
- –ù–∞–ª–∏—á–∏–µ –ø—Ä–∞–≤–∏–ª–∞ MASQUERADE –¥–ª—è VPN-–ø–æ–¥—Å–µ—Ç–∏
- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å, —á–µ—Ä–µ–∑ –∫–æ—Ç–æ—Ä—ã–π –∏–¥–µ—Ç NAT (–æ–±—ã—á–Ω–æ eth0 –∏–ª–∏ ens3)
–ü—Ä–∏–º–µ—Ä –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞:
```
Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination
1     1534 125K MASQUERADE  all  --  *      eth0    10.8.0.0/24          0.0.0.0/0
```
### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–≤–∞—Ä–¥–∏–Ω–≥:
–°–∏—Å—Ç–µ–º–Ω—ã–π —Ñ–æ—Ä–≤–∞—Ä–¥–∏–Ω–≥:
```bash
cat /proc/sys/net/ipv4/ip_forward 
```
* 1 - —Ñ–æ—Ä–≤–∞—Ä–¥–∏–Ω–≥ –≤–∫–ª—é—á–µ–Ω (–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ)
* 0 - —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–∫–ª—é—á–∏—Ç—å –≤ /etc/sysctl.conf
–§–æ—Ä–≤–∞—Ä–¥–∏–Ω–≥ –ø–∞–∫–µ—Ç–æ–≤:
```bash
sudo iptables -L FORWARD -n -v
```
–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
```
Chain FORWARD (policy DROP 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination
 125K   15M ACCEPT     all  --  tun0   eth0    0.0.0.0/0            0.0.0.0/0
  98K 4857K ACCEPT     all  --  eth0   tun0    0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED
```
### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:
# –° –∫–ª–∏–µ–Ω—Ç–∞ VPN:
```
ping 8.8.8.8
ping 8.8.4.4
curl ifconfig.me
```
### –í–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã
- /etc/iptables/rules.v4 - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ firewall
- /etc/sysctl.conf - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —è–¥—Ä–∞
- /var/log/openvpn-status.log - —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π

## **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è**

1. **–°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø—Ä–∞–≤–∏–ª** (`scripts/reset-firewall.sh`):

–î–ª—è —Å–±—Ä–æ—Å–∞ –ø—Ä–∞–≤–∏–ª –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ [—ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç](https://github.com/Zarinec/devops-vpn-project/blob/main/scripts/reset-firewall.sh "reset-firewall.sh")

2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±—ç–∫–∞–ø –ø—Ä–∞–≤–∏–ª (–¥–æ–±–∞–≤–∏—Ç—å –≤ cron):
```bash
0 3 * * * /sbin/iptables-save > /backup/iptables-backup-$(date +\%F).rules
```
3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ—Ä—Ç–æ–≤:
–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ—Ä—Ç–æ–≤, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É:
```bash
ss -tulnp | grep -E '1194|22'
```
  > !!!–ù–∞–±–æ—Ä –ø–æ—Ä—Ç–æ–≤ –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è
